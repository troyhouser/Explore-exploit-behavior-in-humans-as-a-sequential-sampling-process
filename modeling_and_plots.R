# load packages
require(RWiener)
require(see)
require(ggpp)

# load utility functions
source("~/Dropbox (University of Oregon)/foraging_ddm/utils.R")

# parameter intializations (for model fitting below)
inits = c(1,0)

#### drift diffusion model and suicide/depressive decision making strategies
#### drift diffusion model and suicide/depressive decision making strategies
#### drift diffusion model and suicide/depressive decision making strategies

dat = read.csv("~/Dropbox (University of Oregon)/old/suicide/bandit_df1.csv")
dat_grp = read.csv("~/Dropbox (University of Oregon)/old/suicide/bandit_df2.csv")
#bad_ids=c(206270,209460,209468,210548,211705,212385,213227,215644,218207,221273,29829,881091,45709)
#dat_grp2 = dat_grp[!dat_grp$ID %in% bad_ids,]
#dat_grp2 = dat_grp2[dat_grp2$BRAIN_DAMAGE != 2 | is.na(dat_grp2$BRAIN_DAMAGE),]
#dat_grp2 = dat_grp2[dat_grp2$COMMENT %in% keep,]
# get rid of missing responses
dat = dat[dat$choice_numeric!=0,]

# add column for stay/leave decisions
dat = stays_dombrovski(dat)

# vector of subject IDs
S = unique(dat$ID)

# empty list for modeling results
data_ddm = list()

# empty vector for condition assignment
cond = c()

# for every subject ...
for(s in 1:length(S)){
  d = dat[dat$ID==S[s],]
  d = d[(!d$RT<200) & (!is.na(d$stay)) & (!d$RT>20000),]
  q = d$RT / 1000
  resp = ifelse(d$stay==1,"lower","upper")
  d_ddm = list(as.wiener(data.frame(q,resp)))
  data_ddm[[s]] = optim(par=inits,f=ddm,dat=d_ddm)
  cond[s] = dat_grp$COMMENT[dat_grp$ID == S[s]]
}

df_suicide = data.frame(sub = dat_grp$ID,
                        thr = unlist(lapply(data_ddm,function(x) x$par[1])),
                        drift = unlist(lapply(data_ddm,function(x) x$par[2])),
                        group = factor(cond))
write.csv(df_suicide,"~/Dropbox (University of Oregon)/foraging_ddm/3_arm_bandit.csv",row.names = F)

###### ********* can start from here if you dont want to rerun models ***********
df_suicide = read.csv("~/Dropbox (University of Oregon)/foraging_ddm/3_arm_bandit.csv")

# make control group the reference group
df_suicide$group = relevel(factor(df_suicide$group),ref = "CONTROL")

keep = c("CONTROL","DEPRESSION","IDEATOR","ATTEMPTER")

mod_thr = lm(thr ~ group,df_suicide[df_suicide$group %in% keep,])
summary(mod_thr)

mod_drift = lm(drift ~ group,df_suicide[df_suicide$group %in% keep,])
summary(mod_drift)

df_suicide$dep1 = dat_grp$TOTA_MDRS
df_suicide$dep2 = dat_grp
summary(lm(drift ~ group + dep1,df_suicide[df_suicide$group %in% keep,]))

t.test(df_suicide$drift[df_suicide$group == "ATTEMPTER"],
       df_suicide$drift[df_suicide$group == "IDEATOR"],var.equal = T)
t.test(df_suicide$drift[df_suicide$group == "DEPRESSION"],
       df_suicide$drift[df_suicide$group == "IDEATOR"],var.equal = T)

t.test(df_suicide$thr[df_suicide$group == "ATTEMPTER"],
       df_suicide$thr[df_suicide$group == "IDEATOR"],var.equal = T)
t.test(df_suicide$thr[df_suicide$group == "ATTEMPTER"],
       df_suicide$thr[df_suicide$group == "DEPRESSION"],var.equal = T)
t.test(df_suicide$thr[df_suicide$group == "IDEATOR"],
       df_suicide$thr[df_suicide$group == "DEPRESSION"],var.equal = T)

df_suicide_long = reshape2::melt(df_suicide,c("sub","group"))
df_suicide_long = df_suicide_long[df_suicide_long$group %in% keep,]
my_fills = c("gray","#FACB78","#D096FA","#A9FAB6")
ggplot(df_suicide_long[df_suicide_long$variable=="thr",],aes(x = group,y = value,fill = group)) +
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .5),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = "None") +
  scale_fill_manual(values=my_fills)+
  scale_color_manual(values=my_fills)+
  labs(y = "decision threshold",x = "")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggplot(df_suicide_long[df_suicide_long$variable=="drift",],aes(x = group,y = value,fill = group)) +
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .5),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = "None") +
  scale_fill_manual(values=my_fills)+
  scale_color_manual(values=my_fills)+
  labs(y = "drift rate",x = "")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

### drift diffusion model and adverse childhood experiences
### drift diffusion model and adverse childhood experiences
### drift diffusion model and adverse childhood experiences
# 1 = rich; 2 = poor
dat = read.csv("~/Dropbox (University of Oregon)/old/ACEs/ACE_trial_data.csv")
dat_grp = read.csv("~/Dropbox (University of Oregon)/old/ACEs/ACE_dataset.csv")
dat = dat[dat$Participant.ID %in% dat_grp$Participant.ID,]
bad_ids = c(140,141,142,143,144,145)

# vector of subject IDs
S = unique(dat$Participant.ID)[-bad_ids]

# empty list for modeling results
data_ddm_poor = data_ddm_rich = list()

# empty vector for condition assignment
cond = c()

for(c in 1:2){
  # for every subject ...
  for(s in 1:length(S)){
    d = dat[dat$Participant.ID==S[s] & dat$Environment==c,]
    d = d[(!d$Reaction.Time<200) & (!is.na(d$Response)) & (!d$Reaction.Time>20000),]
    q = d$Reaction.Time / 1000
    resp = ifelse(d$Response=="S","lower","upper")
    d_ddm = list(as.wiener(data.frame(q,resp)))
    cond[s] = dat_grp$ACE_Group[dat_grp$Participant.ID == S[s]]
    if(c == 1){
      data_ddm_rich[[s]] = optim(par=inits,f=ddm,dat=d_ddm)
    }else{
      data_ddm_poor[[s]] = optim(par=inits,f=ddm,dat=d_ddm)
    }
  }
}

thr_rich = unlist(lapply(data_ddm_rich,function(x) x$par[1]))
thr_poor = unlist(lapply(data_ddm_poor,function(x) x$par[1]))
drift_rich = unlist(lapply(data_ddm_rich,function(x) x$par[2]))
drift_poor = unlist(lapply(data_ddm_poor,function(x) x$par[2]))

df_aces = data.frame(thr = c(thr_rich,thr_poor),
                drift = c(drift_rich,drift_poor),
                sub = rep(S,2),
                aces = rep(cond,2),
                env = rep(c("rich","poor"),each = length(S)))
write.csv(df_aces,"~/Dropbox (University of Oregon)/foraging_ddm/patch_foraging.csv",row.names = F)

###### ********* can start from here if you dont want to rerun models ***********
df_aces = read.csv("~/Dropbox (University of Oregon)/foraging_ddm/patch_foraging.csv")

# rename aces labels
df_aces$aces = ifelse(df_aces$aces==1,"high ACEs","low ACEs")
df_aces = df_aces[!df_aces$sub %in% c(1604584,1490849),]
ggplot(df_aces,aes(x = aces,y = thr,fill = env)) +
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .1),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = c(.55,.9)) +
  scale_fill_manual(values=c("#E87664","#72A890"))+
  scale_color_manual(values=c("#E87664","#72A890"))+
  labs(x = "",y = "decision threshold") +
  guides(fill = guide_legend(title=""))

ggplot(df_aces,aes(x = aces,y = drift,fill = env)) +
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .1),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = c(.52,.9)) +
  scale_fill_manual(values=c("#E87664","#72A890"))+
  scale_color_manual(values=c("#E87664","#72A890"))+
  labs(x = "",y = "drift rate") +
  guides(fill = guide_legend(title=""))
# mixed model predicting thresholds
mod1 = lmerTest::lmer(thr ~ aces * env + (1|sub),df_aces)
summary(mod1)

# mixed model predicting drifts
mod2 = lmerTest::lmer(drift ~ aces * env + (1|sub),df_aces)
summary(mod2)

### drift diffusion model and cognitive maps
### drift diffusion model and cognitive maps
### drift diffusion model and cognitive maps

source("~/Dropbox (University of Oregon)/cognitivemaps-master/dataProcessing.R")
dat = dataImport(normalize = F)
dat = stays_wu(dat)
S = unique(dat$id)

# empty lists for modeling results
data_ddm_spatial = data_ddm_concept = list()
# vector for different contexts
conds = c("Spatial","Conceptual")
# vector for condition assignment / environment type label
cond = c()
cb = c()
# for each context ...
for(c in 1:2){
  # for every subject ...
  for(s in 1:length(S)){
    d = dat[dat$id==S[s] & dat$context==conds[c],]
    cond[s] = d$environment[1]
    cb[s] = ifelse(d$contextOrder[1] == 0,"spatial first","conceptual first")
    d = d[(d$ts < 20000) & (d$ts > 200),]
    d = d[!is.na(d$chosen),]
    d = d[!is.na(d$stay),]
    q = d$ts / 1000
    resp = ifelse(d$stay==1,"lower","upper")
    d_ddm = list(as.wiener(data.frame(q,resp)))
    if(c == 1){
      data_ddm_spatial[[s]] = optim(par=inits,f=ddm,dat=d_ddm)
    }else{
      data_ddm_concept[[s]] = optim(par=inits,f=ddm,dat=d_ddm)
    }
  }
}


thr_spatial = unlist(lapply(data_ddm_spatial,function(x) x$par[1]))
thr_concept = unlist(lapply(data_ddm_concept,function(x) x$par[1]))
drift_spatial = unlist(lapply(data_ddm_spatial,function(x) x$par[2]))
drift_concept = unlist(lapply(data_ddm_concept,function(x) x$par[2]))

df = data.frame(thr = c(thr_spatial,thr_concept),
                drift = c(drift_spatial,drift_concept),
                context = rep(conds,each=length(S)),
                sub = rep(S,2),
                env = rep(cond,2),
                order = rep(cb,2))
write.csv(df,"~/Dropbox (University of Oregon)/foraging_ddm/64_arm_bandit.csv",row.names = F)

###### ********* can start from here if you dont want to rerun models ***********
df = read.csv("~/Dropbox (University of Oregon)/foraging_ddm/64_arm_bandit.csv")
# rename environment type
df$env = ifelse(df$env==1,"rough","smooth")

# mixed model predicting thresholds
mod1 = lmerTest::lmer(thr ~ context * env * order + (1|sub),df)
summary(mod1)

# mixed model predicting drifts
mod2 = lmerTest::lmer(drift ~ context * env * order + (1|sub),df)
summary(mod2)

# mixed model predicting thresholds controlling for context order

t.test(df$thr[df$order=="spatial first"&df$context=="Spatial"&df$env=="smooth"],
       df$thr[df$order=="conceptual first"&df$context=="Spatial"&df$env=="smooth"])
t.test(df$thr[df$order=="spatial first"&df$context=="Spatial"&df$env=="rough"],
       df$thr[df$order=="conceptual first"&df$context=="Spatial"&df$env=="rough"])

ggplot(df,aes(x = context, y = thr, fill = env))+
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .1),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = c(.505,.75)) +
  scale_fill_manual(values=c("#4DADB3","#DFB090"))+
  scale_color_manual(values=c("#4DADB3","#DFB090"))+
  labs(y = "decision threshold") +
  guides(fill = guide_legend(title = "")) +
  facet_wrap(~order)

ggplot(df,aes(x = context, y = drift, fill = env))+
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .1),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = c(.505,.75)) +
  scale_fill_manual(values=c("#4DADB3","#DFB090"))+
  scale_color_manual(values=c("#4DADB3","#DFB090"))+
  labs(y = "drift rate") +
  guides(fill = guide_legend(title = "")) +
  facet_wrap(~order)

##### drift diffusion model and time horizons
##### drift diffusion model and time horizons
##### drift diffusion model and time horizons

dat = NULL
experiments = c("Exp1 (lab)","Exp4 (lab)","Exp2 (Mturk)","Exp3 (Mturk)","Exp5 (Mturk)")
for(e in 1:length(experiments)){
  dir = paste0("~/Dropbox (University of Oregon)/old/minimalEE/csv_data/",experiments[e])
  files = list.files(dir)
  for(f in 1:length(files)){
    d = read.csv(paste0(dir,"/",files[f]))
    d$sub = (1000 * e) + f
    d$exp = experiments[e]
    dat = rbind(dat,d)
  }
}

time_horizons = unique(dat$T)[order(unique(dat$T),decreasing = F)]
S = unique(dat$sub)
fits = thrs = drifts = matrix(nrow = length(S),ncol = length(time_horizons))

for(tt in 1:length(time_horizons)){
  for(s in 1:length(S)){
    d = dat[dat$T == time_horizons[tt] & dat$sub == S[s],]
    d = d[d$RT < 20000 & d$RT > 200,]
    q = d$RT / 1000
    resp = ifelse(d$choice==1,"lower","upper")
    d_ddm = list(as.wiener(data.frame(q,resp)))
    data_ddm = optim(par=inits,f=ddm,dat=d_ddm)
    fits[s,tt] = data_ddm$value
    thrs[s,tt] = data_ddm$par[1]
    drifts[s,tt] = data_ddm$par[2]
  }
}

df_horizons = data.frame(fits = c(fits),
                         thr = c(thrs),
                         drift = c(drifts),
                         time_horizon = factor(rep(time_horizons,each=length(S))),
                         sub = rep(S,length(time_horizons)))
write.csv(df_horizons,"~/Dropbox (University of Oregon)/foraging_ddm/2_arm_bandit.csv",row.names = F)

###### ********* can start from here if you dont want to rerun models ***********
df_horizons = read.csv("~/Dropbox (University of Oregon)/foraging_ddm/2_arm_bandit.csv")

mod3 = lmerTest::lmer(thr ~ as.numeric(time_horizon) + (1|sub),df_horizons)
summary(mod3)
mod4 = lmerTest::lmer(drift ~ as.numeric(time_horizon) + (1|sub),df_horizons)
summary(mod4)
mod3b = lmerTest::lmer(thr ~ factor(time_horizon) + (1|sub),df_horizons)
summary(mod3b)
mod4b = lmerTest::lmer(drift ~ factor(time_horizon) + (1|sub),df_horizons)
summary(mod4b)

ggplot(df_horizons,aes(x = time_horizon, y = thr, fill = factor(time_horizon)))+
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .5),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = "N0.002, p < .01one") +
  scale_fill_brewer(palette = 1)+
  labs(y = "decision threshold",x = "time horizon")

ggplot(df_horizons,aes(x = time_horizon, y = drift, fill = factor(time_horizon)))+
  geom_jitter(position = position_jitterdodge(dodge.width =.6,jitter.width = .5),size = 4,shape = 21,col = "black") +
  geom_violinhalf(position = position_nudgedodge(x=.1),col = "black") +
  geom_point(stat="summary",position = position_dodge(.6),shape = 18,size=6,col = "black") +
  geom_errorbar(stat="summary",position = position_dodge(.6),col = "black",width = .2,size=1.5) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),text = element_text(size=30),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = "None") +
  scale_fill_brewer(palette = 1)+
  labs(y = "drift rate", x = "time horizon")


############################################ simulations

require(easyRT)
sim <- ddm_data(drift = c(-5, 0, 2, 5), bs = 1, bias = .5, ndt = .2)

ddm_plot(sim)


# Load necessary library
library(ggplot2)

# Function to simulate one trial of the drift diffusion model
simulate_ddm_trial <- function(v, a, z, s, Ter) {
  dt <- 0.001  # time step
  evidence <- z  # initial evidence
  time <- 0  # start time
  
  while (evidence > 0 && evidence < a) {
    evidence <- evidence + rnorm(1, mean = v * dt, sd = s * sqrt(dt))
    time <- time + dt
  }
  
  RT <- time + Ter  # total reaction time
  choice <- ifelse(evidence >= a, 1, 0)  # decision boundary reached (1 for upper, 0 for lower)
  
  return(list(RT = RT, choice = choice))
}

# Function to run multiple trials of the drift diffusion model
simulate_ddm <- function(n_trials, v_mean, v_sd, a, z_mean, z_sd, s, Ter) {
  results <- data.frame(RT = numeric(n_trials), choice = numeric(n_trials))
  
  for (i in 1:n_trials) {
    v <- rnorm(1, mean = v_mean, sd = v_sd)  # drift rate for each trial
    z <- rnorm(1, mean = z_mean, sd = z_sd)  # starting point for each trial
    trial <- simulate_ddm_trial(v, a, z, s, Ter)
    results$RT[i] <- trial$RT
    results$choice[i] <- trial$choice
  }
  
  return(results)
}

# Set parameters
v_mean <- 0  # mean drift rate
v_sd <- 1  # standard deviation of drift rate
a <- 1  # boundary separation
z_mean <- a / 2  # mean starting point (middle of boundaries)
z_sd <- 0.1  # standard deviation of starting point
s <- 0.1  # noise standard deviation
Ter <- 0.3  # non-decision time
n_trials <- 1000  # number of trials

# Run simulation
simulation_results <- simulate_ddm(n_trials, v_mean, v_sd, a, z_mean, z_sd, s, Ter)

# Plot results
ggplot(simulation_results, aes(x = RT, fill = as.factor(choice))) +
  geom_histogram(position = "identity", alpha = 0.5, bins = 50) +
  labs(title = "Drift Diffusion Model Simulation",
       x = "Reaction Time (s)",
       y = "Frequency",
       fill = "Choice") +
  theme_minimal()

ratings = rnorm(50000,3,1)
ratings = ratings[!(ratings< 1 | ratings > 5)]
hist(ratings)

ddm = function(x,datlist){
  loss = 0
  for(var in 1:length(datlist)){
    loss = loss - logLik(wdm(datlist[[var]],
                             alpha = x[var],tau = 0.1,beta = 0.5,delta = x[var+1]))
  }
  loss
}

position_nudgedodge <- function(x = 0, y = 0, width = 0.75) {
  ggproto(NULL, PositionNudgedodge,
          x = x,
          y = y,
          width = width
  )
}

PositionNudgedodge <- ggproto("PositionNudgedodge", PositionDodge,
                              x = 0,
                              y = 0,
                              width = 0.3,
                              
                              setup_params = function(self, data) {
                                l <- ggproto_parent(PositionDodge,self)$setup_params(data)
                                append(l, list(x = self$x, y = self$y))
                              },
                              
                              compute_layer = function(self, data, params, layout) {
                                d <- ggproto_parent(PositionNudge,self)$compute_layer(data,params,layout)
                                d <- ggproto_parent(PositionDodge,self)$compute_layer(d,params,layout)
                                d
                              }
)

stays_dombrovski = function(dat){
  for(s in 1:length(S)){
    d = dat[dat$ID==S[s],]
    stay = c()
    for(i in 2:nrow(d)){
      if(d$choice_numeric[i] == d$choice_numeric[i-1]){
        stay[i] = 1
      }else{
        stay[i] = 0
      }
    }
    dat[dat$ID==S[s],"stay"] = stay
  }
  dat
}

stays_wu = function(dat){
  for(s in 1:length(S)){
    d = dat[dat$id==S[s],]
    stay = c()
    for(i in 2:nrow(d)){
      if(isTRUE(d$chosen[i] == d$chosen[i-1])){
        stay[i] = 1
      }else{
        stay[i] = 0
      }
    }
    dat[dat$id==S[s],"stay"] = stay
  }
  dat
}
